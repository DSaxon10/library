// This extension integrates Optimizely Edge w/ Amplitude via an identify call
// Identifying the Optimizely Edge Object

var OptyObj = window.optimizelyEdge.get('state').getActiveExperimentStates();
var expObj = OptyObj[Object.keys(OptyObj)[0]]; 

function getCampaignInfo() {
return expObj;
}

//Log Event for tracking
function logEvent() {
    
  var campaignInfo = getCampaignInfo();

  if (campaignInfo) {
    var eventProperties = {
      '[Optimizely Campaign]': campaignInfo.id,
      '[Optimizely Experiment]': campaignInfo.id,
      '[Optimizely Variation]': campaignInfo.variation.id,
      //'[Optimizely Holdback]': campaignInfo.holdback
    };
    amplitude.getInstance().logEvent('Test: ' + campaignInfo.name, eventProperties);
  }
}


function identifyCall() {
  
  var campaignInfo = getCampaignInfo();

  if (campaignInfo) {
    var identify = new amplitude.Identify().set(
      '[Optimizely Experiment] '+ campaignInfo.id,
      campaignInfo.variation.id
    );
    amplitude.getInstance().identify(identify);
  }
}

var MAX_ATTEMPTS = 9;

function sendToAmplitude(call) {
  if (call >= MAX_ATTEMPTS) {
    return;
  }

  if (
    window.amplitude &&
    window.amplitude._instances &&
    window.amplitude._instances['$default_instance'] &&
    window.amplitude._instances['$default_instance'].options &&
    window.amplitude._instances['$default_instance'].options.apiKey
  ) {
    identifyCall();
    
    // if (extension.sendevent === 'y') {
    //  logEvent();
   //}
  
  } else {
    return setTimeout(function () {
      sendToAmplitude(call + 1);
    },
    1000);
  }
}

sendToAmplitude(0);
